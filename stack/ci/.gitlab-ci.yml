# # â•­â”€[local templates] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# # â”‚
# .deployNexusSignupTemplate:
#   extends:
#     - .env.nexus-signup.build
#     - .deployTemplate
#   before_script:
#     - |
#       if [[ $FREEZE_NEXUS_SIGNUP_DEPLOYMENTS ]]; then
#         if [[ ! $CI_JOB_MANUAL ]]; then
#           export FREEZED=true
#         fi
#       fi
#   needs: &deploy-needs
#     - prepare:env
#     - nexus-signup:build
#     - job: nexus-signup:publish:assets
#       artifacts: false
#     - job: nexus-signup:publish:image
#       artifacts: false
# # â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# .notifyNexusSignupTemplate:
#   extends:
#     - .notifyTemplate
#   variables:
#     PRODUCT_NAME: Nexus Signup
#     CHANGELOG: "$NEXUS_SIGNUP_CHANGELOG"
#   rules:
#     - if: $IS_DEFAULT
#     - if: $IS_HOTFIX_NEXUS_SIGNUP
# # â”‚
# # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

# # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Pipeline Stages â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# # â•­â”€ Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# # â”‚
# nexus-signup:build:
#   extends:
#     - .buildTemplate
#     - .env.nexus-signup.build
#   rules:
#     - if: $IS_DEFAULT
#     - if: $IS_HOTFIX_NEXUS_SIGNUP
#     - if: $IS_MR
#       when: manual
#       allow_failure: true
# # â”œâ”€â”€â”€/review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# nexus-signup:build:review:
#   retry: 2
#   extends:
#     - nexus-signup:build
#     - .env.nexus-signup.review
#   rules:
#     - if: $IS_MR
# # â”‚
# # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

# # â•­â”€ Publish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# # â”œâ”€â”€â”€/assets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:publish:assets:
#   retry: 2
#   extends:
#     - .publishAssetsTemplate
#   variables:
#     BUILD_VERSION: $NEXUS_SIGNUP_BUILD_VERSION
#     LOCAL_BUILD_PATH: /.next
#     REMOTE_BUILD_PATH: /nexus-signup/$NEXUS_SIGNUP_BUILD_VERSION/assets
#   needs:
#     - prepare:env
#     - nexus-signup:build
#     - job: hotfix
#       optional: true
#       artifacts: false
#   rules:
#     - if: $IS_DEFAULT
#     - if: $IS_HOTFIX_NEXUS_SIGNUP
# # â”‚
# # â”œâ”€â”€â”€/image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:publish:image:
#   retry: 2
#   extends:
#     - .publishImageTemplate
#     - .env.nexus-signup.common
#     - .env.nexus-signup.dev
#   needs:
#     - prepare:env
#     - job: prepare:base-image
#       artifacts: false
#     - nexus-signup:build
#     - job: hotfix
#       optional: true
#       artifacts: false
#   rules:
#     - if: $IS_DEFAULT
#     - if: $IS_HOTFIX_NEXUS_SIGNUP
# # â”‚
# # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
# #
# # â•­â”€ Intermediate Triggers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# # â”œâ”€â”€â”€/review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:review:
#   stage: trigger
#   extends:
#     - .publishTemplate
#     - .env.nexus-signup.review
#   needs:
#     - job: nexus-signup:build:review
#       artifacts: false
#   script:
#     - echo "Publishing Nexus Signup App for review â $CI_ENVIRONMENT_NAME"
#   rules:
#     - if: $NEXUS_SIGNUP_REVIEW_AUTO_DEPLOY
#       when: never
#     - if: $IS_MR
#       when: manual
#       allow_failure: true
# # â”‚
# # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
# #
# # â•­â”€ K8s Deployments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# # â”œâ”€â”€â”€/dev â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:deploy:dev:
#   retry: 2
#   stage: deploy:dev
#   extends:
#     - .deployNexusSignupTemplate
#     - .env.nexus-signup.dev
#   variables:
#     RETRY_SCHEMA_IF_ALREADY_RESOLVED: "false"
#   rules:
#     - if: $IS_DEFAULT && $FREEZE_NEXUS_SIGNUP_DEPLOYMENTS
#       when: manual
#     - if: $IS_DEFAULT

# # â”‚
# # â”œâ”€â”€â”€/promote â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:promote:
#   extends:
#     - .promoteTemplate
#   variables:
#     LOCAL_PACKAGE_NAME: nexus-signup
#   needs:
#     - job: nexus-signup:publish:assets
#       artifacts: false
#     - job: nexus-signup:publish:image
#       artifacts: false
#   rules:
#     - if: $IS_DEFAULT
#       when: manual
#     - if: $IS_HOTFIX_NEXUS_SIGNUP
#       when: manual
# # â”‚
# # â”œâ”€â”€â”€/image:prod â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:publish:image:prod:
#   stage: publish:prod
#   extends:
#     - .publishImageTemplate
#     - .env.nexus-signup.common
#     - .env.nexus-signup.prod
#   needs:
#     - prepare:env
#     - job: prepare:base-image
#       artifacts: false
#     - nexus-signup:build
#     - job: hotfix
#       optional: true
#       artifacts: false
#     - job: nexus-signup:promote
#   rules:
#     - if: $IS_DEFAULT
#     - if: $IS_HOTFIX_NEXUS_SIGNUP

# # â”‚
# # â”œâ”€â”€â”€/production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:deploy:prod:
#   retry: 2
#   stage: deploy:prod
#   extends:
#     - .deployNexusSignupTemplate
#     - .env.nexus-signup.prod
#   needs:
#     - *deploy-needs
#     - job: nexus-signup:publish:image:prod
#       artifacts: false
#   rules:
#     - if: $IS_DEFAULT
#     # when: manual # Delegated to promote
#     - if: $IS_HOTFIX_NEXUS_SIGNUP
#       # when: manual # Delegated to promote
# # â”‚
# # â”œâ”€â”€â”€/reviews (image) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:publish:image:review:
#   retry: 2
#   extends:
#     - .publishImageTemplate
#     - .env.nexus-signup.common
#     - .env.nexus-signup.review
#   needs:
#     - prepare:env
#     - job: prepare:base-image
#       artifacts: false
#     - job: nexus-signup:build:review
#       artifacts: false
#     - job: nexus-signup:review
#       artifacts: false
#   rules:
#     - if: $IS_MR
# # â”‚
# # â”œâ”€â”€â”€/reviews (deploy) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:deploy:review:
#   retry: 2
#   extends:
#     - .deployNexusSignupTemplate
#     - .env.nexus-signup.review
#   stage: deploy:review
#   needs:
#     - job: nexus-signup:build:review
#       artifacts: false
#     - job: nexus-signup:review
#       artifacts: false
#     - job: nexus-signup:publish:image:review
#       artifacts: false
#   environment:
#     name: review/$CI_COMMIT_REF_NAME
#     url: https://$CI_ENVIRONMENT_SLUG.feature.bettermode.dev
#     on_stop: nexus-signup:stop:review
#     auto_stop_in: 2 week
#   script:
#     - ops init -i -e devops@bettermode.com -u $OPS_USERNAME -p $OPS_PASSWORD
#     - ops feature deploy -n $REVIEW_APP_NAME -i $AWS_IMAGE_REGISTRY/$SERVICE_IMAGE_TAG -b $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
#   after_script:
#     - |
#       if [[ ! $NEXUS_SIGNUP_REVIEW_AUTO_DEPLOY ]]; then
#         curl -s --request POST --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
#         "$CI_API_V4_URL/projects/$CI_PROJECT_ID/variables" --form "key=NEXUS_SIGNUP_REVIEW_AUTO_DEPLOY" --form "environment_scope=$CI_ENVIRONMENT_NAME" --form "value=true" --form "protected=false"
#       fi
#   rules:
#     - if: $IS_MR
#       when: manual
# # â”‚
# # â”œâ”€â”€â”€/reviews (stop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:stop:review:
#   retry: 2
#   extends:
#     - .deployNexusSignupTemplate
#     - .env.nexus-signup.review
#   stage: stop:review
#   needs:
#     - job: nexus-signup:deploy:review
#       artifacts: false
#   environment:
#     name: review/$CI_COMMIT_REF_NAME
#     action: stop
#   variables:
#     GIT_STRATEGY: none
#   before_script:
#     - |
#       if [[ $NEXUS_SIGNUP_REVIEW_AUTO_DEPLOY ]]; then
#         curl --request DELETE --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
#         "$CI_API_V4_URL/projects/$CI_PROJECT_ID/variables/NEXUS_SIGNUP_REVIEW_AUTO_DEPLOY" --data-urlencode "filter[environment_scope]=$CI_ENVIRONMENT_NAME"

#         echo "Removed auto-deploy flag for $CI_ENVIRONMENT_NAME environment"
#       fi
#   script:
#     - ops init -i -e devops@bettermode.com -u $OPS_USERNAME -p $OPS_PASSWORD
#     - ops feature delete -n $REVIEW_APP_NAME
#   rules:
#     - if: $IS_MR
#       when: manual
#       allow_failure: true
# # â”‚
# # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
# #
# # â•­â”€ Release Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# # â”œâ”€â”€â”€/dev â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:notify:dev:
#   extends:
#     - .notifyNexusSignupTemplate
#   needs:
#     - prepare:env
#     - nexus-signup:build
#     - nexus-signup:deploy:dev
#   variables:
#     RELEASE_CHANNEL: Dev
#     ACTIONS: nexus-signup:deploy:dev/Dev/Re-deploy to Dev ğŸ”„,nexus-signup:promote/Prod/Promote to Production ğŸ‰
#     SKIP_NOTIFY: $NEXUS_SIGNUP_BUILD_REUSED
#   rules:
#     - if: $IS_DEFAULT
# # â”‚
# # â”œâ”€â”€â”€/production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# # â”‚
# nexus-signup:notify:prod:
#   extends:
#     - .notifyNexusSignupTemplate
#   needs:
#     - prepare:env
#     - nexus-signup:deploy:prod
#   variables:
#     RELEASE_CHANNEL: Prod
#     ACTIONS: nexus-signup:deploy:prod/Prod/Re-deploy to Prod ğŸ”„
# # â”‚
# # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
# # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

